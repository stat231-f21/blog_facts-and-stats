---
title: "data-wrangling"
output: pdf_document
---

```{r setup, include = FALSE}
# load packages
library(readxl)
library(mdsr)
library(tidyverse)
library(dplyr)
library(knitr)
library(ggplot2)
library(janitor)
library(vroom) # fast reading/importing data
library(sf) # spacial data
library(tigris) # geojoin
library(leaflet) # interactive maps
library(htmlwidgets) # interactive map labels

# set code chunk defaults
knitr::opts_chunk$set(tidy = F, # display code as typed
                      size = "small", # slightly smaller code font
                      message = FALSE,
                      warning = FALSE,
                      comment = "\t") 
# set black & white default plot theme 
# theme_set(theme_classic()) # uncomment this line if desired
# improve digit and NA display 
options(scipen = 1, knitr.kable.NA = '')
```

## Data Import
```{r, eval = TRUE}
# Incarceration Trends
incarceration_trends <- vroom("incarceration_trends.csv")
incarceration_rates <- read_csv("prison_policy_initiative_incarceration_by_race.csv")
incarceration_populations <- read_csv("bjs_total_correctional_population_counts_by_status_TM 5_26_21.csv")
incarceration_rates_race <- read_csv("prison_policy_initiative_incarceration_by_race.csv") # data from 2010
rates_by_race <- read_csv("sentencing_project_rates_by_race.csv")
ratio_bw <- read_csv("ratio_bw.csv")
```

## Data Wrangling
```{r, eval = TRUE}
# read in shapefile
unzip(zipfile = "geography resource/cb_2018_us_county_500k.zip")
county_shapefile <- read_sf("cb_2018_us_county_500k.shp") %>%
  janitor::clean_names() 

# take out statefp and countyfp and rename geoid column into fips
county_shapefile <- county_shapefile %>%
  select(- statefp, - countyfp) %>%
  mutate(fips = as.numeric(geoid))

head(county_shapefile)

# save the wrangled shapefile
# st_write(county_shapefile, "county_shapefile_wrangled.shp") <- only run once, so the file does
#not get overwritten each time
```

## Incarceration Trends Wrangling
```{r, eval = TRUE}
incarceration_trends <- incarceration_trends %>%
  separate(county_name, c("county", NA), sep = " ") %>%
  filter(state != "AK", state != "HI") %>%
  mutate(
    total_jail_prison_pop_rate = total_jail_pop_rate + total_prison_pop_rate
  )

write_csv(incarceration_trends, "incarceration_trends_wrangled.csv")
```

## Incarceration by State Wrangling
```{r, eval = TRUE}
#rename necessary columns
incarceration_rates_race <- incarceration_rates_race %>% 
  rename(ID = "...3",
         rate_per_100 = "...26") %>% 
  #delete United States row and remove states and territories not in Continental United States
  filter(ID != "United States", 
         ID != "Puerto Rico", 
         ID != "Geography", 
         ID != "Hawaii", 
         ID != "Alaska") %>%
#Make state names lowercase to match geom dataset and change rate column to numeric
  mutate(ID = tolower(ID),
         #Take out commas from rates column
         rate_per_100 = gsub(",","", as.character(rate_per_100)),
         rate_per_100 = as.numeric(rate_per_100))
```

#Population Time-Series wrangling
```{r, eval = TRUE}
incarceration_populations <- incarceration_populations %>% 
  rename(total_incarcerated = "...7",
         year = "Bureau of Justice Statistics",
         total_supervised = "...2",
         local_jail = "...8",
         state_prison = "...10",
         federal_prison = "...11") %>%
  filter(total_incarcerated != "Total/c", !row_number() %in% c(1)) %>%
  separate(year, c("year",NA), sep = "/d") %>%
  mutate(
    total_incarcerated = as.numeric(gsub(",","", as.character(total_incarcerated))),
    total_supervised = as.numeric(gsub(",","", as.character(total_supervised))),
    local_jail = as.numeric(gsub(",","", as.character(local_jail))),
    state_prison = as.numeric(gsub(",","", as.character(state_prison))),
    federal_prison = as.numeric(gsub(",","", as.character(federal_prison))),
    year = as.numeric(year))
```

#Incarceration Rates by Race wrangling
```{r, eval = TRUE}
# define a function to capitalize each word of state names
simpleCap <- function(x) {
  s <- strsplit(x, " ")[[1]]
  paste(toupper(substring(s, 1, 1)), substring(s, 2),
        sep = "", collapse = " ")
}

rates_by_race <- rates_by_race %>% 
  # change variable type of the rates of each race
  mutate(Black = as.numeric(Black),
         Latino = as.numeric(Latino),
         White = as.numeric(White),
         # change the state names using the defined function
         State = sapply(State, simpleCap)) %>%
  arrange(State) %>%
  # pivot longer for graphing
  pivot_longer(!State, names_to = "race", values_to = "rate")

write_csv(rates_by_race, "rates_by_race_wrangled.csv")
```

#Ratio
```{r, eval = TRUE}
# rename certain variables
ratio_bw <- ratio_bw %>% 
  rename(ID = State,
        ratio = "Ratio (B/W)") %>%
  # change variable types
  mutate(ID = tolower(ID),
        ratio = as.numeric(ratio))
```

