---
title: "data-wrangling"
output: pdf_document
---

```{r setup, include = FALSE}
# load packages
library(readxl)
library(mdsr)
library(tidyverse)
library(dplyr)
library(knitr)
library(ggplot2)
library(janitor)
library(vroom) # fast reading/importing data
library(sf) # spacial data
library(tigris) # geojoin
library(leaflet) # interactive maps
library(htmlwidgets) # interactive map labels

# set code chunk defaults
knitr::opts_chunk$set(tidy = F, # display code as typed
                      size = "small", # slightly smaller code font
                      message = FALSE,
                      warning = FALSE,
                      comment = "\t") 
# set black & white default plot theme 
# theme_set(theme_classic()) # uncomment this line if desired
# improve digit and NA display 
options(scipen = 1, knitr.kable.NA = '')
```

## Data Import
```{r, eval = TRUE}
# Incarceration Trends
incarceration_trends <- vroom("incarceration_trends.csv")
incarceration_rates <- read_csv("prison_policy_initiative_incarceration_by_race.csv")
incarceration_populations <- read_csv("bjs_total_correctional_population_counts_by_status_TM 5_26_21.csv")
incarceration_rates_race <- read_csv("prison_policy_initiative_incarceration_by_race.csv") # data from 2010
rates_by_race <- read_csv("sentencing_project_rates_by_race.csv")
ratio_bw <- read_csv("ratio_bw.csv")
```

## Data Wrangling
```{r, eval = TRUE}
# read in shapefile
unzip(zipfile = "geography resource/cb_2018_us_county_500k.zip")
county_shapefile <- read_sf("cb_2018_us_county_500k.shp") %>%
  janitor::clean_names() 

# take out statefp and countyfp and rename geoid column into fips
county_shapefile <- county_shapefile %>%
  select(-statefp, -countyfp) %>%
  mutate(fips = as.numeric(geoid))
head(county_shapefile)
```

## Incarceration Trends Wrangling
```{r, eval = TRUE}
incarceration_trends<- incarceration_trends %>%
  separate(county_name, c("county",NA), sep = " ") %>%
  filter(state != "AK", state != "HI")

write_csv(incarceration_trends, "incarceration_trends_wrangled.csv")
```

## Incarceration by State Wrangling
```{r, eval = TRUE}
#rename necessary columns
incarceration_rates_race <- incarceration_rates_race %>% rename(ID = "...3" ) %>% rename(rate_per_100 = "...26")
#delete United States row and remove states and territories not in Continental United States
incarceration_rates_race <- incarceration_rates_race %>% filter(ID!="United States", ID!="Puerto Rico", ID!="Geography", ID!="Hawaii", ID!="Alaska")
#Make state names lowercase to match geom dataset and change rate column to numeric
incarceration_rates_race <- incarceration_rates_race %>% mutate(ID = tolower(incarceration_rates_race$ID))%>% mutate(rate_per_100 = as.numeric(rate_per_100))
  
#Take out commas from rates column
incarceration_rates_race$rate_per_100<-gsub(",","",as.character(incarceration_rates_race$rate_per_100))
```

#Population Time-Series wrangling
```{r, eval = TRUE}
incarceration_populations <- incarceration_populations %>% 
  rename(total_incarcerated = "...7") %>% 
  rename(year = "Bureau of Justice Statistics") %>% 
  rename(total_supervised = "...2") %>%
  rename(local_jail = "...8") %>%
  rename(state_prison = "...10") %>%
  rename(federal_prison = "...11")


incarceration_populations <- incarceration_populations %>% filter(total_incarcerated != "Total/c")%>%filter(!row_number() %in% c(1))%>%
  separate(year, c("year",NA), sep = "/d")

incarceration_populations$total_incarcerated<-gsub(",","",as.character(incarceration_populations$total_incarcerated))

incarceration_populations$total_supervised<-gsub(",","",as.character(incarceration_populations$total_supervised))

incarceration_populations$local_jail<-gsub(",","",as.character(incarceration_populations$local_jail))

incarceration_populations$state_prison<-gsub(",","",as.character(incarceration_populations$state_prison))

incarceration_populations$federal_prison<-gsub(",","",as.character(incarceration_populations$federal_prison))

incarceration_populations <- incarceration_populations  %>% 
  mutate(total_incarcerated = as.numeric(total_incarcerated))%>% 
  mutate(year = as.numeric(year)) %>% 
  mutate(total_supervised = as.numeric(total_supervised)) %>% 
  mutate(local_jail = as.numeric(local_jail)) %>%
  mutate(state_prison = as.numeric(state_prison)) %>%
  mutate(federal_prison = as.numeric(federal_prison))
```

#Incarceration Rates by Race wrangling
```{r, eval = TRUE}

rates_by_race <- rates_by_race %>% 
  rename(ID = State) %>%
  mutate(ID = tolower(rates_by_race$ID)) %>%
  mutate(Black = as.numeric(Black),
         Latino = as.numeric(Latino),
         White = as.numeric(White),
         ID = toupper(rates_by_race$ID))

rates_by_race <- rates_by_race %>%
  pivot_longer(!ID, names_to = "race", values_to = "rate")

rates_by_race <- rates_by_race %>% rename(ID = State ) 
rates_by_race <- rates_by_race %>% mutate(ID = tolower(rates_by_race$ID))%>% mutate(Black = as.numeric(Black))%>% mutate(Latino = as.numeric(Latino))%>% mutate(White = as.numeric(White))

rates_by_race <- rates_by_race %>%
  pivot_longer(!ID, names_to = "race", values_to = "rate")

rates_by_race$ID <- gsub("^(\\w)(\\w+)", "\\U\\1\\L\\2", 
  rates_by_race$ID, perl = TRUE)

rates_by_race %>% arrange(ID)
```
#Ratio
```{r, eval = TRUE}

ratio_bw <- ratio_bw %>% rename(ID = State ) %>% rename(ratio= "Ratio (B/W)" ) 

ratio_bw <- ratio_bw %>% mutate(ID = tolower(ratio_bw$ID))

ratio_bw <- ratio_bw %>% mutate(ratio = as.numeric(ratio))
```

